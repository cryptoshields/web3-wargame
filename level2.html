<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Level 2 ‚Äî NFT Approval Trap</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: #fff;
      margin: 0;
    }
    .top-bar {
      background: #111;
      padding: 0.8rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
    }
    .warning-bar {
      background-color: #ff3d00;
      color: #fff;
      padding: 0.75rem;
      text-align: center;
      font-weight: bold;
      font-size: 0.9rem;
    }
    .frame-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 120px);
      padding: 1rem;
    }
    .card {
      background: rgba(0, 0, 0, 0.85);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 0 18px #ff9800;
      max-width: 540px;
      width: 100%;
      text-align: center;
    }
    h1 {
      margin-bottom: 0.3rem;
    }
    .section-title {
      margin-top: 2rem;
      font-size: 1.2rem;
      font-weight: bold;
      text-transform: uppercase;
    }
    .button-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    .separator {
      margin: 2rem auto;
      width: 80%;
      height: 2px;
      background: #ff9800;
    }
    button {
      padding: 1rem 2rem;
      font-size: 1rem;
      background: #ff9800;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    #status {
      margin-top: 2rem;
      font-size: 1.1rem;
      white-space: pre-wrap;
      text-align: left;
    }
    #nextBtn {
      display: none;
      background: #4caf50;
      padding: 1rem;
      border-radius: 8px;
      color: #fff;
      text-decoration: none;
      margin-top: 2rem;
    }
    .tooltip-box {
      margin-top: 2rem;
      padding: 1rem;
      background: #333;
      border-left: 4px solid #ff9800;
      text-align: left;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>Web3 War Game</div>
    <div>‚úÖ Survived: <span id="surviveCount">0</span> | üíÄ Drained: <span id="failCount">0</span></div>
  </div>

  <div class="warning-bar">
    ‚ö†Ô∏è This is a testnet simulation. Use a burner wallet with Sepolia ETH only. Never connect a real wallet.
  </div>

  <div class="frame-container">
    <div class="card">
      <h1>üé≠ Level 2: Animate Your NFT</h1>
      <p>Looks like a fun NFT staking or animation. Should you trust it?</p>

      <div class="section-title">ONE CLICK DRAIN SIMULATION</div>
      <div class="button-container">
        <button id="connectBtn">Connect Wallet</button>
        <button id="drainAllBtn" disabled>Animate NFT / DRAIN</button>
      </div>

      <div class="separator"></div>

      <div class="section-title">STEP BY STEP SIMULATION</div>
      <p>This simulation allows you to see what your wallet asks you to sign.</p>
      <div class="button-container">
        <button id="approveBtn" disabled>Approve</button>
        <button id="drainSingleBtn" disabled>Animate NFT / DRAIN</button>
        <button id="revokeBtn" disabled>Revoke</button>
      </div>

      <div id="status"></div>
      <a href="level3.html" id="nextBtn">‚û°Ô∏è Proceed to Level 3</a>

      <div class="tooltip-box">
        üí° <strong>Did you know?</strong><br>
        Signing an ERC721 `setApprovalForAll()` grants a contract full control over every NFT you own in a collection ‚Äî instantly and permanently.<br><br>
        This approval happens at the collection level. That means all NFTs from the same collection in your wallet can be drained ‚Äî without any further confirmation.<br><br>
        üö® Scammers exploit this through fake staking, animation, airdrop, and raffle dApps.<br><br>
        ‚ö†Ô∏è Until you revoke the approval, every NFT in that collection is exposed. This is why you should never approve entire collections from wallets where you hold multiple valuable tokens. Use dedicated wallets for platforms that require such approvals.
      </div>
    </div>
  </div>

  <script>
    const nftContracts = [
      "0x72Fb81C679Cb531fe2104be9d68a20f41fB0B604", // WarGameNFT
      "0xc4b837Eb523A82F5214d43200af1491B93185979"  // HappyApeYC
    ];
    const drainerContract = "0x0103e8d6e07057829d99E57eD31420694bA4C4E3"; // BatchNFTDrainer

    const nftABI = [
      "function setApprovalForAll(address operator, bool approved) public",
      "function balanceOf(address owner) public view returns (uint256)",
      "function tokensOwned(address owner) view returns (uint256[] memory)",
      "function name() public view returns (string)"
    ];
    const drainerABI = [
      "function approveAndDrain(address[] calldata nftContracts, address victim) external"
    ];

    let provider, signer, drainer, userAddress;

    function updateCounters() {
      document.getElementById("surviveCount").textContent = localStorage.getItem("w3game_survived") || 0;
      document.getElementById("failCount").textContent = localStorage.getItem("w3game_failed") || 0;
    }

    document.getElementById("connectBtn").onclick = async () => {
      const status = document.getElementById("status");
      if (!window.ethereum) return alert("Please install MetaMask.");

      try {
        status.innerText = "‚è≥ Connecting wallet...";
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        const network = await provider.getNetwork();
        if (network.chainId !== 11155111) {
          status.innerText = "‚ùå Switch to Sepolia testnet.";
          return;
        }

        drainer = new ethers.Contract(drainerContract, drainerABI, signer);
        let nftSummary = `‚úÖ Connected: ${userAddress}\n\nüéÅ NFTs Detected:\n`;

        for (let addr of nftContracts) {
          const nft = new ethers.Contract(addr, nftABI, signer);
          const name = await nft.name();
          const balance = await nft.balanceOf(userAddress);
          if (balance.eq(0)) {
            nftSummary += `- ${name}: 0 NFTs\n`;
          } else {
            const tokens = await nft.tokensOwned(userAddress);
            nftSummary += `- ${name} (${tokens.length}): ${tokens.map(t => `#${t}`).join(", ")}\n`;
          }
        }

        status.innerText = nftSummary;
        document.getElementById("drainAllBtn").disabled = false;
        document.getElementById("approveBtn").disabled = false;
      } catch (err) {
        console.error("Connection error:", err);
        status.innerText = "‚ùå Wallet connection failed.";
      }
    };

    document.getElementById("drainAllBtn").onclick = async () => {
      const status = document.getElementById("status");
      try {
        status.innerText = "‚ö†Ô∏è Animating NFTs... Draining initiated!";
        const tx = await drainer.approveAndDrain(nftContracts, userAddress);
        await tx.wait();
        status.innerText = "üíÄ All NFTs drained from your collections.";
        localStorage.setItem("w3game_level2", "drained");
        localStorage.setItem("w3game_failed", (parseInt(localStorage.getItem("w3game_failed")) || 0) + 1);
        updateCounters();
        document.getElementById("nextBtn").style.display = "inline-block";
      } catch (err) {
        if (err.code === "ACTION_REJECTED") {
          status.innerText = "‚úÖ You rejected the drain transaction. Well done!";
          localStorage.setItem("w3game_level2", "survived");
          localStorage.setItem("w3game_survived", (parseInt(localStorage.getItem("w3game_survived")) || 0) + 1);
          updateCounters();
          document.getElementById("nextBtn").style.display = "inline-block";
        } else {
          status.innerText = `‚ùå Error: ${err.message}`;
        }
      }
    };

    document.getElementById("approveBtn").onclick = async () => {
      const nft = new ethers.Contract(nftContracts[1], nftABI, signer); // Only HappyApeYC
      try {
        const tx = await nft.setApprovalForAll(drainerContract, true);
        await tx.wait();
        document.getElementById("drainSingleBtn").disabled = false;
        document.getElementById("revokeBtn").disabled = false;
        document.getElementById("status").innerText = "‚úÖ Approval set for HappyApeYC.";
      } catch (err) {
        document.getElementById("status").innerText = "‚ùå Approval failed.";
      }
    };

    document.getElementById("drainSingleBtn").onclick = async () => {
      document.getElementById("drainAllBtn").click();
    };

    document.getElementById("revokeBtn").onclick = async () => {
      const nft = new ethers.Contract(nftContracts[1], nftABI, signer); // Revoke only HappyApeYC
      try {
        const tx = await nft.setApprovalForAll(drainerContract, false);
        await tx.wait();
        document.getElementById("status").innerText = "üõ°Ô∏è Approval revoked.";
      } catch (err) {
        document.getElementById("status").innerText = "‚ùå Failed to revoke approval.";
      }
    };

    window.onload = () => {
      updateCounters();
      document.getElementById("nextBtn").style.display = "none";
    };
  </script>
</body>
</html>
