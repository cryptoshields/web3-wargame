<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Level 1 ‚Äî ERC20 Approval Trap</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: #fff;
      margin: 0;
      overflow-x: hidden;
    }
    .top-bar {
      background: #111;
      padding: 0.8rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
    }
    .warning-bar {
      background-color: #ff3d00;
      color: #fff;
      padding: 0.75rem;
      text-align: center;
      font-weight: bold;
      font-size: 0.9rem;
    }
    .frame-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: calc(100vh - 120px);
      position: relative;
    }
    .card {
      background: rgba(0, 0, 0, 0.85);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 0 18px #ff9800;
      max-width: 540px;
      width: 100%;
      text-align: center;
      z-index: 2;
    }
    .button-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    button {
      padding: 1rem 2rem;
      font-size: 1rem;
      background: #ff9800;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    #status {
      margin-top: 2rem;
      font-size: 1.1rem;
      white-space: pre-wrap;
      text-align: left;
    }
    #nextBtn {
      display: none;
      background: #4caf50;
      padding: 1rem;
      border-radius: 8px;
      color: #fff;
      text-decoration: none;
      margin-top: 2rem;
    }
    .token-drain {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 120px;
      height: 120px;
      margin-top: -60px;
      margin-left: -60px;
      border-radius: 50%;
      background: radial-gradient(circle, red, transparent 70%);
      animation: drain 0.7s ease-out;
      pointer-events: none;
      z-index: 5;
    }
    @keyframes drain {
      0% { transform: scale(0); opacity: 1; }
      100% { transform: scale(10); opacity: 0; }
    }
    .chain-break {
      position: absolute;
      top: 30px;
      right: 30px;
      font-size: 2rem;
      color: #ff3d00;
      animation: pulse 1.5s ease-out;
    }
    @keyframes pulse {
      0% { transform: scale(0.5); opacity: 0.2; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    .overlay-popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      padding: 1rem 1.5rem;
      border: 2px solid #ff9800;
      color: #fff;
      border-radius: 12px;
      font-size: 1rem;
      z-index: 999;
      animation: fadeOut 3s forwards;
    }
    @keyframes fadeOut {
      0% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; display: none; }
    }
    .tooltip-box {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #333;
      border-left: 4px solid #ff9800;
      text-align: left;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>Approve & Pray</div>
    <div>‚úÖ Survived: <span id="surviveCount">0</span> | üíÄ Drained: <span id="failCount">0</span></div>
  </div>

  <div class="warning-bar">
    ‚ö†Ô∏è This is a testnet simulation. Use a burner wallet with Sepolia ETH only. Never connect a real wallet.
  </div>

  <div class="frame-container">
    <div class="card">
      <h1>üéØ Level 1: Claim WGFAKE</h1>
      <p>This looks like a token reward, but is it safe?</p>
      <div class="button-container">
        <button id="connectBtn">Connect Wallet</button>
        <button id="faucetBtn" disabled>Claim 100 WGFAKE Tokens</button>
        <button id="claimBtn" disabled>Claim Reward</button>
        <button id="revokeBtn" disabled>Reset Allowance</button>
      </div>
      <div id="status"></div>
      <a href="level2.html" id="nextBtn">‚û°Ô∏è Proceed to Level 2</a>
      <div class="tooltip-box">
        üí° <strong>Did you know?</strong><br>
        ERC20 `approve()` gives another address permission to move your tokens. <br>
        Approvals remain until revoked ‚Äî scammers rely on this.
        <br><br>
        For NFTs, the function may look like:<br>
        <code>approve(address to, uint256 tokenId)</code>
        ‚Äî which can expose individual tokens to transfers!
      </div>
    </div>
  </div>

  <script>
    const tokenAddress = "0xc93f592f0541c6dBAab200Af9E58ECE17ea1B60f";
    const scammerAddress = "0x4231c68D8b2500307507F324fd80B2eB3E206785";
    const tokenABI = [
      "function approve(address spender, uint256 amount) public returns (bool)",
      "function allowance(address owner, address spender) public view returns (uint256)",
      "function balanceOf(address account) public view returns (uint256)",
      "function transferFrom(address from, address to, uint256 amount) public returns (bool)",
      "function faucet() external"
    ];

    const SUPABASE_URL = 'https://wtlsmtfzawyvnozjcbkd.supabase.co';
    const SUPABASE_ANON_KEY = 'your-actual-supabase-anon-key'; // Replace with your Supabase key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let provider, signer, token, userAddress;

    function updateCounters() {
      document.getElementById("surviveCount").textContent = localStorage.getItem("w3game_survived") || 0;
      document.getElementById("failCount").textContent = localStorage.getItem("w3game_failed") || 0;
    }

    async function logResult(result) {
      if (!userAddress) return;
      try {
        await supabase.from("leaderboard_logs").insert({
          address: userAddress.toLowerCase(),
          level: "1",
          outcome: result,
          timestamp: new Date().toISOString()
        });
        console.log("Leaderboard logged:", result);
      } catch (err) {
        console.error("Supabase error:", err);
      }
    }

    function showOverlay(msg) {
      const div = document.createElement("div");
      div.className = "overlay-popup";
      div.innerText = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    function animateTrap() {
      const tokenEffect = document.createElement("div");
      tokenEffect.className = "token-drain";
      document.body.appendChild(tokenEffect);

      const chainBreak = document.createElement("div");
      chainBreak.className = "chain-break";
      chainBreak.innerHTML = "‚õìÔ∏èüí•";
      document.body.appendChild(chainBreak);

      setTimeout(() => {
        tokenEffect.remove();
        chainBreak.remove();
      }, 1000);
    }

    async function checkAllowance() {
      if (!token || !userAddress) return 0;
      const allowance = await token.allowance(userAddress, scammerAddress);
      console.log("Current allowance:", ethers.utils.formatEther(allowance), "WGFAKE");
      return allowance;
    }

    document.getElementById("connectBtn").onclick = async () => {
      const status = document.getElementById("status");
      if (!window.ethereum) {
        alert("Please install MetaMask.");
        return;
      }
      try {
        status.innerText = "‚è≥ Connecting...";
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        token = new ethers.Contract(tokenAddress, tokenABI, signer);
        console.log("Token contract initialized at:", tokenAddress);

        const network = await provider.getNetwork();
        if (network.chainId !== 11155111) {
          status.innerText = "‚ùå Please switch to Sepolia Testnet.";
          return;
        }

        status.innerText = `‚úÖ Connected: ${userAddress}`;
        document.getElementById("faucetBtn").disabled = false;
        document.getElementById("revokeBtn").disabled = false;
        const balance = await token.balanceOf(userAddress);
        console.log("User balance:", ethers.utils.formatEther(balance), "WGFAKE");
        document.getElementById("claimBtn").disabled = balance.lt(ethers.utils.parseEther("100"));
        await checkAllowance();
      } catch (err) {
        console.error("Connection error:", err);
        status.innerText = "‚ùå Failed to connect: " + (err.message || "Try again.");
      }
    };

    document.getElementById("faucetBtn").onclick = async () => {
      const status = document.getElementById("status");
      if (!signer || !token) return alert("Connect your wallet first.");
      try {
        status.innerText = "ÔøΩÂ∞±ÊúâÂ∫è Claiming 100 WGFAKE tokens...";
        const tx = await token.faucet();
        console.log("Faucet tx hash:", tx.hash);
        await tx.wait();
        const balance = await token.balanceOf(userAddress);
        console.log("User balance after faucet:", ethers.utils.formatEther(balance), "WGFAKE");
        status.innerText = `‚úÖ Successfully claimed 100 WGFAKE tokens!\nCurrent balance: ${ethers.utils.formatEther(balance)} WGFAKE`;
        document.getElementById("claimBtn").disabled = balance.lt(ethers.utils.parseEther("100"));
        showOverlay("üéâ Tokens Claimed!");
      } catch (err) {
        console.error("Faucet error:", err);
        status.innerText = "‚ùå Failed to claim tokens: " + (err.reason || err.message || "Try again?");
      }
    };

    document.getElementById("revokeBtn").onclick = async () => {
      const status = document.getElementById("status");
      if (!signer || !token) return alert("Connect your wallet first.");
      try {
        status.innerText = "‚è≥ Resetting allowance...";
        const tx = await token.approve(scammerAddress, 0);
        console.log("Revoke tx hash:", tx.hash);
        await tx.wait();
        await checkAllowance();
        status.innerText = `‚úÖ Allowance reset! The scammer can no longer transfer your tokens.`;
        showOverlay("üõ°Ô∏è Allowance Reset!");
      } catch (err) {
        console.error("Revoke error:", err);
        status.innerText = "‚ùå Failed to reset allowance: " + (err.reason || err.message || "Try again?");
      }
    };

    document.getElementById("claimBtn").onclick = async () => {
      const status = document.getElementById("status");
      if (!signer || !token) return alert("Connect your wallet first.");

      try {
        const balance = await token.balanceOf(userAddress);
        console.log("User balance before approve:", ethers.utils.formatEther(balance), "WGFAKE");
        if (balance.lt(ethers.utils.parseEther("100"))) {
          status.innerText = "‚ùå Insufficient WGFAKE balance. Claim tokens using the faucet first.";
          return;
        }

        status.innerText = "üö® Sending approval...";
        const approveAmount = ethers.utils.parseEther("100");
        const tx = await token.approve(scammerAddress, approveAmount);
        console.log("Approve tx hash:", tx.hash);
        await tx.wait();
        status.innerText = "‚úÖ Approval transaction confirmed. Checking allowance...";

        // Wait for blockchain state to update
        await new Promise(resolve => setTimeout(resolve, 2000));

        const allowance = await checkAllowance();
        if (allowance.lt(approveAmount)) {
          status.innerText = `‚ùå Allowance not set correctly. Expected: ${ethers.utils.formatEther(approveAmount)}, Got: ${ethers.utils.formatEther(allowance)}. Try resetting allowance.`;
          return;
        }

        status.innerText = "üö® Simulating scammer draining tokens...";
        const tx2 = await token.transferFrom(userAddress, scammerAddress, approveAmount);
        console.log("TransferFrom tx hash:", tx2.hash);
        await tx2.wait();
        animateTrap();
        showOverlay("‚ö†Ô∏è Tokens Drained!");
        status.innerText = `üíÄ Approval Granted + Tokens Drained!\n\nüëâ Scam Type: ERC20 \`approve()\` + \`transferFrom()\`\nYou just gave access to your tokens ‚Äî and the scammer took them immediately.\n\nüõë Reset allowance using the button above or:\nüîó https://revoke.cash\n\nüß† Tip: Always read transactions, and never approve blindly.`;
        localStorage.setItem("w3game_level1", "drained");
        let failCount = parseInt(localStorage.getItem("w3game_failed") || 0);
        localStorage.setItem("w3game_failed", failCount + 1);
        updateCounters();
        await logResult("drained");
        document.getElementById("nextBtn").style.display = "inline-block";
      } catch (err) {
        if (err.code === "ACTION_REJECTED") {
          status.innerText = `‚úÖ You survived Level 1!\n\nüõ°Ô∏è You rejected a suspicious approval request that could‚Äôve drained your tokens.\n\nStay vigilant.`;
          localStorage.setItem("w3game_level1", "survived");
          let surviveCount = parseInt(localStorage.getItem("w3game_survived") || 0);
          localStorage.setItem("w3game_survived", surviveCount + 1);
          updateCounters();
          await logResult("survived");
          document.getElementById("nextBtn").style.display = "inline-block";
        } else {
          console.error("Claim error:", err);
          status.innerText = `‚ö†Ô∏è Error: ${err.reason || err.message || "Check allowance/balance or try resetting allowance."}`;
        }
      }
    };

    window.onload = () => {
      updateCounters();
      document.getElementById("nextBtn").style.display = "none";
      document.getElementById("faucetBtn").disabled = true;
      document.getElementById("claimBtn").disabled = true;
      document.getElementById("revokeBtn").disabled = true;
      if (window.ethereum) {
        window.ethereum.on("chainChanged", (chainId) => {
          if (parseInt(chainId) !== 11155111) {
            document.getElementById("status").innerText = "‚ùå Please switch to Sepolia Testnet.";
            document.getElementById("faucetBtn").disabled = true;
            document.getElementById("claimBtn").disabled = true;
            document.getElementById("revokeBtn").disabled = true;
            signer = null;
            token = null;
          }
        });

        window.ethereum.on("accountsChanged", (accounts) => {
          if (accounts.length === 0) {
            document.getElementById("status").innerText = "‚ùå Wallet disconnected. Please reconnect.";
            document.getElementById("faucetBtn").disabled = true;
            document.getElementById("claimBtn").disabled = true;
            document.getElementById("revokeBtn").disabled = true;
            signer = null;
            token = null;
          }
        });
      }
    };
  </script>
</body>
</html>
