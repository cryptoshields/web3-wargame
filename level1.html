<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Level 1 ‚Äî ERC20 Approval Trap</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: #fff;
      margin: 0;
      overflow-x: hidden;
    }
    .top-bar {
      background: #111;
      padding: 0.8rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
    }
    .warning-bar {
      background-color: #ff3d00;
      color: #fff;
      padding: 0.75rem;
      text-align: center;
      font-weight: bold;
      font-size: 0.9rem;
    }
    .frame-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: calc(100vh - 120px);
      position: relative;
    }
    .card {
      background: rgba(0, 0, 0, 0.85);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 0 18px #ff9800;
      max-width: 540px;
      width: 100%;
      text-align: center;
      z-index: 2;
    }
    .button-container {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    button {
      padding: 1rem 2rem;
      font-size: 1rem;
      background: #ff9800;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
    }
    #status {
      margin-top: 2rem;
      font-size: 1.1rem;
      white-space: pre-wrap;
      text-align: left;
    }
    #nextBtn {
      display: none;
      background: #4caf50;
      padding: 1rem;
      border-radius: 8px;
      color: #fff;
      text-decoration: none;
      margin-top: 2rem;
    }
    .token-drain {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 120px;
      height: 120px;
      margin-top: -60px;
      margin-left: -60px;
      border-radius: 50%;
      background: radial-gradient(circle, red, transparent 70%);
      animation: drain 0.7s ease-out;
      pointer-events: none;
      z-index: 5;
    }
    @keyframes drain {
      0% { transform: scale(0); opacity: 1; }
      100% { transform: scale(10); opacity: 0; }
    }
    .chain-break {
      position: absolute;
      top: 30px;
      right: 30px;
      font-size: 2rem;
      color: #ff3d00;
      animation: pulse 1.5s ease-out;
    }
    @keyframes pulse {
      0% { transform: scale(0.5); opacity: 0.2; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    .overlay-popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      padding: 1rem 1.5rem;
      border: 2px solid #ff9800;
      color: #fff;
      border-radius: 12px;
      font-size: 1rem;
      z-index: 999;
      animation: fadeOut 3s forwards;
    }
    @keyframes fadeOut {
      0% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; display: none; }
    }
    .tooltip-box {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #333;
      border-left: 4px solid #ff9800;
      text-align: left;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>Approve & Pray</div>
    <div>‚úÖ Survived: <span id="surviveCount">0</span> | üíÄ Drained: <span id="failCount">0</span></div>
  </div>

  <div class="warning-bar">
    ‚ö†Ô∏è This is a testnet simulation. Use a burner wallet with Sepolia ETH only. Never connect a real wallet.
  </div>

  <div class="frame-container">
    <div class="card">
      <h1>üéØ Level 1: Claim WGFAKE</h1>
      <p>This looks like a token reward, but is it safe?</p>
      <div class="button-container">
        <button id="connectBtn">Connect Wallet</button>
        <button id="claimBtn">Claim Reward</button>
      </div>
      <div id="status"></div>
      <a href="level2.html" id="nextBtn">‚û°Ô∏è Proceed to Level 2</a>
      <div class="tooltip-box">
        üí° <strong>Did you know?</strong><br>
        ERC20 `approve()` gives another address permission to move your tokens. <br>
        Approvals remain until revoked ‚Äî scammers rely on this.
        <br><br>
        For NFTs, the function may look like:<br>
        <code>approve(address to, uint256 tokenId)</code>
        ‚Äî which can expose individual tokens to transfers!
      </div>
    </div>
  </div>

  <script>
  const tokenAddress = "0xc93f592f0541c6dBAab200Af9E58ECE17ea1B60f";
  const spenderAddress = "0x4231c68D8b2500307507F324fd80B2eB3E206785";
  const tokenABI = [
  "function approve(address spender, uint256 amount) public returns (bool)",
  "function allowance(address owner, address spender) public view returns (uint256)",
  "function transferFrom(address sender, address recipient, uint256 amount) public returns (bool)",
  "function balanceOf(address owner) public view returns (uint256)"
];


  const SUPABASE_URL = 'https://wtlsmtfzawyvnozjcbkd.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJI...'; // keep this truncated safely
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let provider, signer, token, userAddress;

  function updateCounters() {
    document.getElementById("surviveCount").textContent = localStorage.getItem("w3game_survived") || 0;
    document.getElementById("failCount").textContent = localStorage.getItem("w3game_failed") || 0;
  }

  async function logResult(result) {
    if (!userAddress) return;
    await supabase.from("leaderboard_logs").insert({
      address: userAddress.toLowerCase(),
      level: "1",
      outcome: result,
      timestamp: new Date().toISOString()
    });
  }

  function showOverlay(msg) {
    const div = document.createElement("div");
    div.className = "overlay-popup";
    div.innerText = msg;
    document.body.appendChild(div);
  }

  function animateTrap() {
    const tokenEffect = document.createElement("div");
    tokenEffect.className = "token-drain";
    document.body.appendChild(tokenEffect);

    const chainBreak = document.createElement("div");
    chainBreak.className = "chain-break";
    chainBreak.innerHTML = "‚õìÔ∏èüí•";
    document.body.appendChild(chainBreak);

    setTimeout(() => {
      tokenEffect.remove();
      chainBreak.remove();
    }, 1000);
  }

  document.getElementById("connectBtn").onclick = async () => {
    const status = document.getElementById("status");
    if (!window.ethereum) {
      alert("Please install MetaMask.");
      return;
    }
    try {
      status.innerText = "‚è≥ Connecting...";
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      token = new ethers.Contract(tokenAddress, tokenABI, signer);

      const network = await provider.getNetwork();
      if (network.chainId !== 11155111) {
        status.innerText = "‚ùå Please switch to Sepolia Testnet.";
        return;
      }

      status.innerText = `‚úÖ Connected: ${userAddress}`;
    } catch (err) {
      console.error("Connection error:", err);
      status.innerText = "‚ùå Failed to connect.";
    }
  };

  document.getElementById("claimBtn").onclick = async () => {
    const status = document.getElementById("status");
    if (!signer || !token) return alert("Connect your wallet first.");

    try {
      status.innerText = "üö® Sending approval...";
      const tx = await token.approve(spenderAddress, ethers.utils.parseUnits("1000", 18));
      await tx.wait();

      // Simulate malicious token drain
      const drainTx = await token.transferFrom(userAddress, spenderAddress, ethers.utils.parseUnits("10", 18));
      await drainTx.wait();

      animateTrap();
      showOverlay("‚ö†Ô∏è Unlimited Approval Granted!");

      status.innerText = `üíÄ Unlimited Approval Granted!

üëâ Scam Type: ERC20 \`approve()\` Trap
You just granted this contract permission to move ALL your WGFAKE tokens.

üö® The contract just drained 10 WGFAKE to the attacker's address.

üõë Revoke this ASAP using:
üîó https://revoke.cash

üß† Tip: Always limit approvals, and never trust flashy "Claim" buttons without reading the transaction.`;

      localStorage.setItem("w3game_level1", "drained");
      let failCount = parseInt(localStorage.getItem("w3game_failed") || 0);
      localStorage.setItem("w3game_failed", failCount + 1);
      updateCounters();
      await logResult("drained");
      document.getElementById("nextBtn").style.display = "inline-block";
    } catch (err) {
      if (err.code === "ACTION_REJECTED") {
        status.innerText = `‚úÖ You survived Level 1!

üõ°Ô∏è You rejected a suspicious approval request that would‚Äôve exposed all your tokens.

Stay vigilant. Approve with caution.`;
        localStorage.setItem("w3game_level1", "survived");
        let surviveCount = parseInt(localStorage.getItem("w3game_survived") || 0);
        localStorage.setItem("w3game_survived", surviveCount + 1);
        updateCounters();
        await logResult("survived");
        document.getElementById("nextBtn").style.display = "inline-block";
      } else {
        console.error(err);
        status.innerText = "‚ö†Ô∏è Unexpected error.";
      }
    }
  };

  window.onload = () => {
    updateCounters();
    document.getElementById("nextBtn").style.display = "none";
  };
</script>

</body>
</html>
